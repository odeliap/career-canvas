@import careercanvas.io.model.job._
@import java.sql.Timestamp
@import play.api.libs.json._
@import play.filters.csrf.CSRF
@(
    jobInfos: Seq[JobInfo]
)(content: Html)(implicit request: MessagesRequestHeader)

@authenticated.user.AuthenticatedUserLayout("Feed | Career Canvas") {
    <div class="main-page">
        <div>
            @request.flash.data.map{ case (name, value) =>
            @if(name.equals("error")) {
            <div class="error-flash">@value</div>
            } else if (name.equals("success")) {
            <div class="success-flash">@value</div>
            } else {
            <div class="info-flash">@value</div>
            }
            }
        </div>

        <div class="arrows-container">
            <button class="arrow-box arrow-left-end status-filter" id="Bookmarked-count" data-filter="Bookmarked">BOOKMARKED</button>
            <button class="arrow-box arrow-right-left status-filter" id="Applying-count" data-filter="Applying">APPLYING</button>
            <button class="arrow-box arrow-right-left status-filter" id="Applied-count" data-filter="Applied">APPLIED</button>
            <button class="arrow-box arrow-right-left status-filter" id="Interviewing-count" data-filter="Interviewing">INTERVIEWING</button>
            <button class="arrow-box arrow-right-left status-filter" id="Offer-count" data-filter="Offer">OFFER</button>
            <button class="arrow-box arrow-right-end status-filter" id="Rejected-count" data-filter="Rejection">REJECTION</button>
        </div>

        <div id="job-search-container">
            <button id="add-job-button">+</button>

            <form id="search" action="#">
                <input type="text" class="search-container" id="searchBox" placeholder="Search by title or company" onkeypress="handle" />
            </form>

            <div>
                <select class="filter-param" id="lastUpdate">
                    <optgroup label="Last Update">
                        <option value="876600" class="default-opt">All time</option>
                        <option value="168">Last 7 days</option>
                        <option value="72">Last 3 days</option>
                        <option value="24">Last 24 hours</option>
                    </optgroup>
                </select>

                <select class="filter-param" id="company">
                    <optgroup label="Company">
                        <option value="" class="default-opt">All companies</option>
                        @for(company <- jobInfos.map(info => "^[a-zA-Z0-9 ]*".r.findFirstIn(info.company).getOrElse("")).distinct) {
                        <option value="@company">@company</option>
                        }
                    </optgroup>
                </select>

                <select class="filter-param" id="location">
                    <optgroup label="Location">
                        <option value="" class="default-opt">All Locations</option>
                        @for(location <- jobInfos.map(info => "^[a-zA-Z0-9 ]*".r.findFirstIn(info.location).getOrElse("")).distinct) {
                        <option value="@location">@location</option>
                        }
                    </optgroup>
                </select>

                <input type="checkbox" id="showStarred">
                <label for="showStarred" id="showStarredLabel"></label>
            </div>
        </div>

        @content

        <button id="jobFeedToggleViewButton">Show List View</button>

        <div id="tiles-view">
            @TilesView(jobInfos)
        </div>

        <div id="list-view">
            @ListView(jobInfos)
        </div>

    </div>

    <div class="pagination">
        <button id="prevPage"><img src="@routes.Assets.versioned("images/authenticated.user/feed/pagination/previous.png")" class="pagination-arrow"></button>
        <div id="pageNumbersContainer"></div>
        <button id="nextPage"><img src="@routes.Assets.versioned("images/authenticated.user/feed/pagination/next.png")" class="pagination-arrow"></button>
    </div>

    @FooterTemplate()
    <script src="@routes.Assets.versioned("javascripts/authenticated.user/feed/jobFilters.js")" type="text/javascript"></script>
    <script src="@routes.Assets.versioned("javascripts/authenticated.user/feed/jobFeedNavigationUnderline.js")" type="text/javascript"></script>
    <script src="@routes.Assets.versioned("javascripts/authenticated.user/feed/search.js")" type="text/javascript"></script>
    <script src="@routes.Assets.versioned("javascripts/authenticated.user/feed/toggleFeedView.js")" type="text/javascript"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
        const statusBtns = document.querySelectorAll('.status-btn');
        const csrfToken = "@CSRF.getToken(request).map(_.value).getOrElse("")";

        statusBtns.forEach(statusBtn => {
            const dropdown = statusBtn.nextElementSibling; // assuming dropdown is next to the statusBtn

            statusBtn.onclick = function(event) {
                event.stopPropagation();
                dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
            }

            dropdown.addEventListener('click', function(event) {
                if (event.target.classList.contains('dropdown-item')) {

                    const activeStatus = dropdown.querySelector('.active-status');
                    if (activeStatus) {
                        activeStatus.classList.remove('active-status');
                    }

                    event.target.classList.add('active-status');

                    statusBtn.textContent = event.target.textContent;
                    dropdown.style.display = 'none';

                    const newStatus = event.target.getAttribute('status');
                    const eventJobId = event.target.getAttribute('data-id');

                    const payload = {
                        status: newStatus,
                        jobId: eventJobId
                    };

                    fetch('@routes.JobFeedController.updateStatus()', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Csrf-Token': csrfToken
                        },
                        body: JSON.stringify(payload)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.redirectTo) {
                            window.location.href = data.redirectTo; // Redirects the browser
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                }
            });
        });

        window.onclick = function() {
            const dropdowns = document.querySelectorAll('.dropdown-menu');
            dropdowns.forEach(dropdown => {
                dropdown.style.display = 'none';
            });
        }
    });
    </script>
}
