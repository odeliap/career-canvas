@import careercanvas.io.model.job._
@import java.sql.Timestamp
@import play.api.libs.json._
@import play.filters.csrf.CSRF
@(
    jobInfos: Seq[JobInfo]
)(content: Html)(implicit request: MessagesRequestHeader)

@authenticated.user.AuthenticatedUserLayout("Feed | Career Canvas") {
    <div class="main-page">
        <div>
            @request.flash.data.map{ case (name, value) =>
            @if(name.equals("error")) {
            <div class="error-flash">@value</div>
            } else if (name.equals("success")) {
            <div class="success-flash">@value</div>
            } else {
            <div class="info-flash">@value</div>
            }
            }
        </div>

        <div class="arrows-container">
            <button class="arrow-box arrow-left-end status-filter" id="Bookmarked-count" data-filter="Bookmarked">BOOKMARKED</button>
            <button class="arrow-box arrow-right-left status-filter" id="Applying-count" data-filter="Applying">APPLYING</button>
            <button class="arrow-box arrow-right-left status-filter" id="Applied-count" data-filter="Applied">APPLIED</button>
            <button class="arrow-box arrow-right-left status-filter" id="Interviewing-count" data-filter="Interviewing">INTERVIEWING</button>
            <button class="arrow-box arrow-right-left status-filter" id="Offer-count" data-filter="Offer">OFFER</button>
            <button class="arrow-box arrow-right-end status-filter" id="Rejected-count" data-filter="Rejection">REJECTION</button>
        </div>

        <div id="job-search-container">
            <button id="add-job-button">+</button>

            <form id="search" action="#">
                <input type="text" class="search-container" id="searchBox" placeholder="Search by title or company" onkeypress="handle" />
            </form>

            <div>
                <select class="filter-param" id="lastUpdate">
                    <optgroup label="Last Update">
                        <option value="876600" class="default-opt">All time</option>
                        <option value="168">Last 7 days</option>
                        <option value="72">Last 3 days</option>
                        <option value="24">Last 24 hours</option>
                    </optgroup>
                </select>

                <select class="filter-param" id="company">
                    <optgroup label="Company">
                        <option value="" class="default-opt">All companies</option>
                        @for(company <- jobInfos.map(info => "^[a-zA-Z0-9 ]*".r.findFirstIn(info.company).getOrElse("")).distinct) {
                        <option value="@company">@company</option>
                        }
                    </optgroup>
                </select>

                <select class="filter-param" id="location">
                    <optgroup label="Location">
                        <option value="" class="default-opt">All Locations</option>
                        @for(location <- jobInfos.map(info => "^[a-zA-Z0-9 ]*".r.findFirstIn(info.location).getOrElse("")).distinct) {
                        <option value="@location">@location</option>
                        }
                    </optgroup>
                </select>

                <input type="checkbox" id="showStarred">
                <label for="showStarred" id="showStarredLabel"></label>
            </div>
        </div>

        @content

        <div id="job-tiles">
            @jobInfos.map { jobInfo =>
            <div class="job-tile" data-status="@jobInfo.status.toString" data-company="@{"^[a-zA-Z0-9 ]*".r.findFirstIn(jobInfo.company)}" data-lastupdate="@jobInfo.lastUpdate.getTime" data-location="@{"^[a-zA-Z0-9 ]*".r.findFirstIn(jobInfo.location)}" data-starred="@jobInfo.starred.toString.toLowerCase()">
            <div class="job-tile-header">

                <div class="job-tile-subheader">
                    <div class="job-company">@{"^[a-zA-Z0-9 ]*".r.findFirstIn(jobInfo.company)}</div>
                    <a href="@routes.JobFeedController.starJob(jobInfo.jobId)">
                        @if(jobInfo.starred) {
                        <img src="@routes.Assets.versioned("images/authenticated.user/feed/tile/filledbookmark.png")" class="bookmark-icon">
                        } else {
                        <img src="@routes.Assets.versioned("images/authenticated.user/feed/tile/bookmark.png")" class="bookmark-icon">
                        }
                    </a>
                </div>

                <p class="job-title">@jobInfo.jobTitle</p>

            </div>
            <div class="metadata-fields">

                <div class="metadata">
                    <div class="metadata-tag" style="background-color: @utils.ColorUtils.jobStatusToColor(jobInfo.status);"></div>
                    <img src="@routes.Assets.versioned("images/authenticated.user/feed/tile/status/" + jobInfo.status + ".png")" alt="@{jobInfo.status}" class="metadata-icon">
                    <p class="meta-title">Status:</p>
                    <div id="status-dropdown">
                        <button class="status-btn">@jobInfo.status.toString.replaceAll("\\d+", "").replaceAll("(.)([A-Z])", "$1 $2")</button>
                        <div class="dropdown-menu" id="statusDropdown">
                            <p class="dropdown-item @(if(jobInfo.status.toString == "Bookmarked") "active-status")" data-id="@jobInfo.jobId" status="Bookmarked">Bookmarked</p>
                            <p class="dropdown-item @(if(jobInfo.status.toString == "Applying") "active-status")" data-id="@jobInfo.jobId" status="Applying">Applying</p>
                            <p class="dropdown-item @(if(jobInfo.status.toString == "Applied") "active-status")" data-id="@jobInfo.jobId" status="Applied">Applied</p>
                            <p class="dropdown-item @(if(jobInfo.status.toString == "Interviewing") "active-status")" data-id="@jobInfo.jobId" status="Interviewing">Interviewing</p>
                            <p class="dropdown-item @(if(jobInfo.status.toString == "Offer") "active-status")" data-id="@jobInfo.jobId" status="Offer">Offer</p>
                            <p class="dropdown-item @(if(jobInfo.status.toString == "Rejected") "active-status")" data-id="@jobInfo.jobId" status="Rejected">Rejected</p>
                        </div>
                    </div>
                </div>

                <div class="metadata">
                    <div class="metadata-tag" style="background-color: @utils.ColorUtils.localDateTimeToColor(jobInfo.lastUpdate.toLocalDateTime);"></div>
                    <img src="@routes.Assets.versioned("images/authenticated.user/feed/tile/calendar.png")" class="metadata-icon">
                    <p class="meta-title">Last Update:</p>
                    <p class="meta-content">
                        @{
                        val now = java.time.LocalDateTime.now()
                        val lastUpdate = jobInfo.lastUpdate.toLocalDateTime
                        val duration = java.time.Duration.between(lastUpdate, now)

                        val formattedTime =
                        if (duration.toSeconds < 60) {
                        "just now"
                        } else if (duration.toMinutes == 1) {
                        "1 minute ago"
                        } else if (duration.toMinutes < 60) {
                        s"${duration.toMinutes} minutes ago"
                        } else if (duration.toHours < 24) {
                        s"${duration.toHours} hours ago"
                        } else {
                        s"${duration.toDays} days ago"
                        }

                        formattedTime
                        }
                    </p>
                </div>
            </div>
            <a href="@routes.IndividualJobController.showJobView(jobInfo)" class="view-job-button">View Job</a>
        </div>
        }
    </div>

    <div class="pagination">
        <button id="prevPage"><img src="@routes.Assets.versioned("images/authenticated.user/feed/pagination/previous.png")" class="pagination-arrow"></button>
        <div id="pageNumbersContainer"></div>
        <button id="nextPage"><img src="@routes.Assets.versioned("images/authenticated.user/feed/pagination/next.png")" class="pagination-arrow"></button>
    </div>

    @FooterTemplate()
    <script src="@routes.Assets.versioned("javascripts/authenticated.user/feed/jobFilters.js")" type="text/javascript"></script>
    <script src="@routes.Assets.versioned("javascripts/authenticated.user/feed/jobFeedNavigationUnderline.js")" type="text/javascript"></script>
    <script src="@routes.Assets.versioned("javascripts/authenticated.user/feed/search.js")" type="text/javascript"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
        const statusBtns = document.querySelectorAll('.status-btn');
        const csrfToken = "@CSRF.getToken(request).map(_.value).getOrElse("")";

        function updateCountForStatus(status) {
            const statusElements = document.querySelectorAll(`[data-status="${status}"]`);

            const count = statusElements.length;

            const countDisplayElementId = `${status}-count`;
            const countDisplayElement = document.getElementById(countDisplayElementId);
            if (countDisplayElement) {
                if (count > 0) {
                    countDisplayElement.innerHTML = `<div><p>${count}</p> <p class="count-display">${status.toUpperCase()}</p></div>`;
                }
            } else {
                console.warn(`No element found with the ID: ${countDisplayElementId}`);
            }

            if (count > 0) {
                countDisplayElement.classList.add('count-arrow-box');
            } else {
                countDisplayElement.classList.remove('count-arrow-box');
            }
        }

        statusBtns.forEach(statusBtn => {
            const dropdown = statusBtn.nextElementSibling; // assuming dropdown is next to the statusBtn

            statusBtn.onclick = function(event) {
                event.stopPropagation();
                dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
            }

            dropdown.addEventListener('click', function(event) {
                if (event.target.classList.contains('dropdown-item')) {

                    const activeStatus = dropdown.querySelector('.active-status');
                    if (activeStatus) {
                        activeStatus.classList.remove('active-status');
                    }

                    event.target.classList.add('active-status');

                    statusBtn.textContent = event.target.textContent;
                    dropdown.style.display = 'none';

                    const newStatus = event.target.getAttribute('status');
                    const eventJobId = event.target.getAttribute('data-id');

                    const payload = {
                        status: newStatus,
                        jobId: eventJobId
                    };

                    updateCountForStatus('Bookmarked');
                    updateCountForStatus('Applying');
                    updateCountForStatus('Applied');
                    updateCountForStatus('Interviewing');
                    updateCountForStatus('Offer');
                    updateCountForStatus('Rejected');

                    fetch('@routes.JobFeedController.updateStatus()', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Csrf-Token': csrfToken
                        },
                        body: JSON.stringify(payload)
                    }).then(response => response.json())
                    .then(data => {
                        console.log(data);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                }
            });
        });

        window.onclick = function() {
            const dropdowns = document.querySelectorAll('.dropdown-menu');
            dropdowns.forEach(dropdown => {
                dropdown.style.display = 'none';
            });
        }
    });
    </script>
}
