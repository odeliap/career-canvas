@import play.api.libs.json._
@import play.filters.csrf.CSRF
@(
    jobInfo: careercanvas.io.model.job.JobInfo,
    responses: Seq[careercanvas.io.model.job.ApplicationFile]
)(implicit request: MessagesRequestHeader)

<div class="response-header">
    <h1>Responses</h1>
</div>
<div class="responses">
    <section class="response-content">
        <button class="response-add-question-btn" onclick="addQuestion()">+</button>

        <div id="questionsContainer"></div>

        <button class="loading-button" id="loadingBtn" style="display:none;">Loading...</button>
    </section>
</div>
<script>
    let questionCount = 0;

    function adjustHeight(textarea) {
        textarea.style.height = "auto";
        textarea.style.height = textarea.scrollHeight + "px";
    }

    function addQuestion() {
        if (questionCount < 10) {
            questionCount++;

            // Create question input area
            const questionDiv = document.createElement('div');
            questionDiv.classList.add('response-question-wrapper');
            questionDiv.id = `questionWrapper${questionCount}`;

            questionDiv.innerHTML = `
                <button class="response-delete-btn" onclick="deleteQuestion(${questionCount})">Delete Ã—</button>
                <input class="response-question-input" type="text" placeholder="Enter Question ${questionCount}" id="question${questionCount}">
                <button class="response-button" onclick="submitQuestion(${questionCount})">Submit</button>
                <textarea class="response-hidden" id="answer${questionCount}"></textarea>
                <button class="response-button save-response-button" onclick="saveResponseWithPrompt(${questionCount})">Save</button>
            `;

            // Append the question area to the container
            document.getElementById('questionsContainer').appendChild(questionDiv);
        } else {
            alert("Maximum of 10 questions reached. Delete responses to add new ones.");
        }
    }

    function deleteQuestion(id) {
        const questionWrapper = document.getElementById(`questionWrapper${id}`);
        document.getElementById('questionsContainer').removeChild(questionWrapper);
        questionCount--;
    }

    function submitQuestion(id) {
        const questionInput = document.getElementById(`question${id}`);

        if (questionInput.value.trim() !== "") {
            const questionInput = document.getElementById(`question${id}`);
            const csrfToken = "@CSRF.getToken(request).map(_.value).getOrElse("")";
            const payload = {
                jobInfo: jobInfoJson,
                question: questionInput.value
            };
            console.log(JSON.stringify(payload));

            // Display the loading button
            document.getElementById('loadingBtn').style.display = 'block';

            fetch("@routes.IndividualJobController.generateResponse()", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Csrf-Token': csrfToken
                },
                body: JSON.stringify(payload),
                redirect: 'follow'
            })
            .then(response => {
                // Hide the loading button regardless of the fetch result
                document.getElementById('loadingBtn').style.display = 'none';

                if (response.ok) {
                    return response.json();
                } else {
                    console.error("Failed to generate response.");
                    return response.text().then(text => console.error(text));
                }
            })
            .then(data => {
                if (data && data.content) {
                    const answerDiv = document.getElementById(`answer${id}`);
                    answerDiv.innerHTML = data.content;
                    answerDiv.classList.remove('response-hidden');

                    const textarea = document.getElementById(`answer${id}`);
                    adjustHeight(textarea);
                }
            })
            .catch(error => {
                // Hide the loading button in case of an error
                document.getElementById('loadingBtn').style.display = 'none';
                console.error("Error fetching response:", error);
            });
        } else {
            alert("Please enter a valid question");
        }
    }

    function saveResponseWithPrompt(id) {
        const questionInput = document.getElementById(`question${id}`);
        const answerInput = document.getElementById(`answer${id}`);
        if (questionInput.value.trim() !== "" && answerInput.value.trim() !== "") {
            const name = prompt("Please enter a name to save:");
            const csrfToken = "@CSRF.getToken(request).map(_.value).getOrElse("")";
            if (name) {
                const responseContent = document.getElementById('answer${questionCount}').innerHTML;

                const payload = {
                    jobId: @jobInfo.jobId,
                    name: name,
                    response: responseContent
                };

                fetch("@routes.IndividualJobController.saveResponse()", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Csrf-Token': csrfToken
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(payload)
                })
                .then(response => response.text())
                .then(data => {
                    document.documentElement.innerHTML = data;
                    const flashMessage = "Response Saved.";
                    alert(flashMessage);
                })
                .catch(error => {
                    console.error('There was an error with the request:', error);
                    alert('Something went wrong when saving the response.');
                });
            }
        } else {
            alert("Please enter a valid question and wait for the response before saving");
        }
    }
</script>