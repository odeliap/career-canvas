@import play.api.libs.json._
@import play.filters.csrf.CSRF
@(
    jobInfo: careercanvas.io.model.job.JobInfo,
    coverLetters: Seq[careercanvas.io.model.job.ApplicationFile]
)(implicit request: MessagesRequestHeader)

<div class="cover-letter">
    <section id="coverLetterContent" class="hidden">
        <div id="adjustmentsSection">
            <label for="adjustButtons">Improve:</label>
            <div id="adjustButtons">
                @careercanvas.io.model.job.ResponseImprovement.values.map { improvement =>
                <button class="custom-button" id="@improvement.toString" onclick="toggleButton(this)">@improvement.toString.split("(?=[A-Z])").mkString(" ")</button>
                }
            </div>
            <div class="custom-input">
                <label for="customText">Custom Improvement Request:</label>
                <textarea id="customText" placeholder="Enter your custom text here"></textarea>
            </div>
            <a id="improveCoverLetterButton" href="javascript:void(0);" onclick="improveCoverLetter()">Improve Cover Letter</a>
        </div>
        <section class="output" id="outputtedContent">
            <label for="generatedLetter">Letter Content</label>
            <textarea id="generatedLetter"></textarea>
        </section>
        <div id="coverLetterActions">
            <a id="saveCoverLetterButton" class="hidden" href="javascript:void(0);" onclick="saveCoverLetterWithPrompt();">Save</a>
            <a id="cancelCoverLetterButton" class="cancel-add hidden" href="javascript:void(0);" onclick="resetView();">Cancel</a>
        </div>
        <div id="loadingPopup" class="loading-popup">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading...</div>
        </div>
    </section>
    <div id="generateSection">
        <a id="generateCoverLetterButton" href="javascript:void(0);" onclick="generateCoverLetter()">
            <div id="generateCoverLetterLeft">
                <div class="cover-letter-plus"></div>
            </div>
            <div id="generateCoverLetterRight">
                <p id="generateCoverLetterButtonTitle">New Cover Letter</p>
                <p id="generateCoverLetterButtonSubtitle">Make a custom cover letter for this application.</p>
            </div>
        </a>
    </div>
</div>
<script>
    const jobInfoJson = @Html(Json.toJson(jobInfo).toString);
</script>
<script>
    const selectedImprovements = new Set();

    function toggleButton(button) {
        const improvementName = button.id;
        if (selectedImprovements.has(improvementName)) {
            selectedImprovements.delete(improvementName);
            button.style.backgroundColor = "";
        } else {
            selectedImprovements.add(improvementName);
            button.style.backgroundColor = "#EF9D7F";
        }
    }

    function clearImprovementsBackground() {
        for (const improvement of selectedImprovements) {
            const improvementButton = document.getElementById(improvement);
            improvementButton.style.backgroundColor = "";
        }
        selectedImprovements.clear();
        const customText = document.getElementById('customText');
        customText.value = "";
    }

    function resetView() {
        clearImprovementsBackground();

        const generatedLetterDiv = document.getElementById('generatedLetter');
        generatedLetterDiv.innerHTML = '';

        const coverLetterContent = document.getElementById('coverLetterContent');
        const saveCoverLetterBtn = document.getElementById('saveCoverLetterButton');
        const cancelCoverLetterBtn = document.getElementById('cancelCoverLetterButton');
        const generateSection = document.getElementById('generateSection');

        coverLetterContent.classList.add('hidden');
        saveCoverLetterBtn.classList.add('hidden');
        cancelCoverLetterBtn.classList.add('hidden');
        generateSection.classList.remove('hidden');
    }

    function showLoadingPopup() {
        const loadingPopup = document.getElementById('loadingPopup');
        loadingPopup.style.display = 'flex';
    }

    function hideLoadingPopup() {
        const loadingPopup = document.getElementById('loadingPopup');
        loadingPopup.style.display = 'none';
    }

    function generateCoverLetter() {
        showLoadingPopup();

        const csrfToken = "@CSRF.getToken(request).map(_.value).getOrElse("")";

        const payload = {
            jobInfo: jobInfoJson
        };

        fetch("@routes.IndividualJobController.generateCoverLetter()", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Csrf-Token': csrfToken
            },
            body: JSON.stringify(payload),
            redirect: 'follow'
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                console.error("Failed to generate cover letter.");
                return response.text().then(text => console.error(text));
            }
        })
        .then(data => {
            if (data && data.content) {
                const generatedLetterDiv = document.getElementById('generatedLetter');
                generatedLetterDiv.innerHTML = data.content;

                const coverLetterContent = document.getElementById('coverLetterContent');
                const saveCoverLetterBtn = document.getElementById('saveCoverLetterButton');
                const cancelCoverLetterBtn = document.getElementById('cancelCoverLetterButton');
                const generateSection = document.getElementById('generateSection');

                coverLetterContent.classList.remove('hidden');
                saveCoverLetterBtn.classList.remove('hidden');
                cancelCoverLetterBtn.classList.remove('hidden');
                generateSection.classList.add('hidden');

                hideLoadingPopup();
            }
        })
        .catch(error => {
            console.error("Error fetching cover letter:", error);
            hideLoadingPopup();
        });
    }

    function improveCoverLetter() {
        showLoadingPopup();

        const content = document.getElementById('generatedLetter').innerHTML;
        const customImprovement = document.getElementById('customText').value;
        const csrfToken = "@CSRF.getToken(request).map(_.value).getOrElse("")";

        const payload = {
            jobInfo: jobInfoJson,
            improvements: Array.from(selectedImprovements),
            customImprovement: customImprovement,
            response: content
        };

        fetch("@routes.IndividualJobController.generateResponseImprovement()", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Csrf-Token': csrfToken
            },
            body: JSON.stringify(payload),
            redirect: 'follow'
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                console.error("Failed to generate cover letter improvement.");
                return response.text().then(text => console.error(text));
            }
        })
        .then(data => {
            if (data && data.content) {
                const generatedLetterDiv = document.getElementById('generatedLetter');
                generatedLetterDiv.innerHTML = data.content;

                clearImprovementsBackground();
                hideLoadingPopup();
            }
        })
        .catch(error => {
            console.error("Error fetching cover letter improvement:", error);
            hideLoadingPopup();
        });
    }

    function saveCoverLetterWithPrompt() {
        const name = prompt("Please enter a name to save:");
        const csrfToken = "@CSRF.getToken(request).map(_.value).getOrElse("")";
        if (name) {
            const coverLetterContent = document.getElementById('generatedLetter').innerHTML;

            const payload = {
                jobId: @jobInfo.jobId,
                name: name,
                coverLetter: coverLetterContent
            };

            var xhr = new XMLHttpRequest();
            xhr.open('POST', "@routes.IndividualJobController.saveCoverLetter()", true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.setRequestHeader('Csrf-Token', csrfToken);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status >= 200 && xhr.status < 300) {
                    console.log('Data saved successfully.');
                    if (xhr.responseURL !== "@routes.IndividualJobController.saveCoverLetter()") {
                        window.location.href = xhr.responseURL;
                    }
                } else if (xhr.readyState === 4) {
                    console.error('Failed to save data.');
                }
            };
            xhr.send(JSON.stringify(payload));
        }
    }
</script>