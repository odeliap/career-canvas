@import play.api.libs.json._
@import play.filters.csrf.CSRF
@(
jobInfo: careercanvas.io.model.job.JobInfo,
coverLetters: Seq[careercanvas.io.model.job.ApplicationFile],
responses: Seq[careercanvas.io.model.job.ApplicationFile],
newCoverLetter: careercanvas.io.model.job.CoverLetter
)(implicit request: play.api.mvc.RequestHeader)

@BaseJobInformationView(jobInfo, coverLetters, responses) {
    <div id="cover-letter">
        <div id="cover-letter-header">
            <h3 id="cover-letter-subheader">Cover Letter</h3>
            <div class="toggle-button active">
                <span class="caret">&#9660;</span>
            </div>
        </div>
        <div class="collapsible-content">
            <textarea id="cover-letter-content">@newCoverLetter.content</textarea>
            <a id="save-cover-letter-button" href="javascript:void(0);" onclick="saveCoverLetterWithPrompt();">Save</a>
        </div>
    </div>
    <script>
        const toggleButton = document.querySelector('.toggle-button');
        const collapsibleContent = document.querySelector('.collapsible-content');
        const caret = document.querySelector('.caret');

        toggleButton.addEventListener('click', function() {
            this.classList.toggle('active');

            if (collapsibleContent.style.display === 'none' || collapsibleContent.style.display === '') {
                collapsibleContent.style.display = 'block';
                caret.innerHTML = '&#9660;'; // down-pointing caret
            } else {
                collapsibleContent.style.display = 'none';
                caret.innerHTML = '&#9654;'; // right-pointing caret
            }
        });

        function saveCoverLetterWithPrompt() {
            const name = prompt("Please enter a name to save:");
            const csrfToken = "@CSRF.getToken(request).map(_.value).getOrElse("")";
            if (name) {
                const coverLetterContent = document.getElementById('cover-letter-content').value;

                const payload = {
                    jobId: @jobInfo.jobId,
                    name: name,
                    responses: @Json.toJson(responses), // Assuming you have a way to serialize 'responses' to JSON.
                    coverLetter: coverLetterContent
                };

                fetch("@routes.JobFeedController.saveCoverLetter()", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Csrf-Token': csrfToken
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(payload)
                })
                .then(response => response.text())
                .then(data => {
                    document.documentElement.innerHTML = data;
                    const flashMessage = "Cover Letter Saved.";
                    alert(flashMessage);
                })
                .catch(error => {
                    console.error('There was an error with the request:', error);
                    alert('Something went wrong when saving the cover letter.');
                });
            }
        }

    </script>
}
